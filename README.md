Bazel Aspects
================

Bazel aspects are a somewhat obscure and poorly understood feature of
bazel that are hard to wrap one's head around.  When would use use
one?  What are they?  How to they work? How do you implement one?

## Why would you want one?

An aspect may be useful to generate some type of artifact parallel to
the kind normally produced by a rule.  The main use case has initially been IDE support (see https://github.com/bazelbuild/e4b/tree/ae17bdebcb1733ff1cb9172043652668fd85725c/com.google.devtools.bazel.e4b/resources/tools/must/be/unique).

## How do they work?

When a rule declares an attribute that uses an aspect, like
`attr.label(aspects = ['foo_aspect']`, bazel looks at the definition
of the aspect to see what attributes it propogates down.  For example,
it might say `attr_aspects = ['deps]`.

When that rule is invoked, bazel will:

1. Traverse down the dependency graph in depth-first fashion,
   following edges named 'deps'.

1. Apply the aspect rule to each matched rule (in this example
   `java_library` and `java_binary`).

As an aspect implementor, your job is to:

1. Check the kind of rule you are visiting via `aspect_ctx.rule.kind`
property.

2. Do something (`ctx.file_action`, `ctx.action`, etc..).

3. Collect a transitive set of generated output files and pass them
   off somewhere to be consumed (either from the command line or a
   another rule).

## How are they invoked?

1. From the command line with the `--aspects` flag (see Makefile).

2. From a rule attribute that declares an aspect (see `java_info`
   rule).

## What can an aspect see?

An aspect implementation can only inspect the information provided by
the `ctx.rule` object: its attributes, dependencies (and their
providers), etc.

However, a *parameterized aspect* can get information about the
originating rule, and do different control flow based on that value.
See the examples.

# GOTCHAS

1. It's critical to propogate the transitive outputs generated by an
   aspect back up the shadow graph.  If you don't do this, you'll can
   spend a fair amount of time scratching your head about why a
   file_action in an aspect is not being actually produced (ask me how
   I know).  Recall that bazel is very lazy so if you don't keep that
   transitive chain going, bazel will prune it away.

2. TO be callable from the command line, it appears necessary to
   implement 'output_groups' in your aspect.  For example
   `--output_groups=dump` or `--output_groups=+dump`, it will generate
   outputs specified in that output group.  You can supress outputs
   that would otherwise be generated by the rule (for java, this is a
   jar file) via `--output_groups=+dump,-default`.
